<% if lesson.lesson_video.attached? %>
  <%
          video_url = lesson.lesson_video
          if lesson.video_start_time.present? || lesson.video_end_time.present?
            fragment = "#t="
            fragment += lesson.video_start_time.to_s if lesson.video_start_time.present?
            fragment += "," + lesson.video_end_time.to_s if lesson.video_end_time.present?
            video_url = url_for(lesson.lesson_video) + fragment
          end
        %>
  <div class="bg-black flex items-center justify-center aspect-[4/3] xl:aspect-auto xl:max-w-[640px] xl:h-[480px] relative group"
          data-controller="video-poster video-player"
          data-video-player-chapters-value="<%= lesson.chapters.to_json(only: [:start_time, :name]) %>">
    <%= video_tag video_url,
            id: 'lesson-video',
            controls: false,
            preload: "metadata",
            class: "w-full h-full object-contain",
            data: {
              video_poster_target: "video",
              video_time_target: "video",
              video_player_target: "video",
              action: "click->video-player#togglePlay"
            } %>
    <%= render 'video_poster', lesson: lesson %>
    <%= render 'shared/video_player_controls' %>
  </div>
<% elsif lesson.video_url.present? %>
  <%
      youtube_id = lesson.video_url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/)&.[](1)
      if youtube_id
        embed_url = "https://www.youtube.com/embed/#{youtube_id}"
        params = []
        params << "start=#{lesson.video_start_time}" if lesson.video_start_time.present?
        params << "end=#{lesson.video_end_time}" if lesson.video_end_time.present?
        embed_url += "?#{params.join('&')}" if params.any?
  %>
  <div class="bg-black flex items-center justify-center aspect-[4/3] xl:aspect-auto xl:max-w-[640px] xl:h-[480px] relative group">
    <iframe
        width="100%"
        height="100%"
        src="<%= embed_url %>"
        title="YouTube video player"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        bind:allowfullscreen="true"
        allowfullscreen
        class="w-full h-full">
    </iframe>
  </div>
<% end %>
<% end %>