<%
  # Check if this blob has copyright metadata (blob-level, shared across all attachments)
  is_copyrighted = blob.metadata['copyrighted'] == true
  purchase_url = blob.metadata['purchase_url']
  # Pages are per-attachment, stored in data-pages attribute on <action-text-attachment>
  # For the editor, we read from the attachment element via JavaScript
  pages = "" # Default to empty (show all pages)
%>
<figure class="attachment attachment--<%= blob.representable? ? "preview" : "file" %> attachment--<%= blob.filename.extension %>">
  <% if blob.filename.extension == 'pdf' %>
    <%= render :partial => '/active_storage/blobs/pdf', locals: {blob: blob, is_copyrighted: is_copyrighted, purchase_url: purchase_url, pages: pages} %>
  <% elsif blob.representable? %>
    <%= image_tag blob.representation(resize_to_limit: local_assigns[:in_gallery] ? [ 800, 600 ] : [ 1024, 768 ]) %>
  <% end %>
  <figcaption class="attachment__caption">
    <% if caption = blob.try(:caption) %>
      <%= caption %>
    <% end %>
  </figcaption>
  <!-- Copyright metadata editor (blob-level, shared across all attachments) -->
  <div class="admin-only mt-2 p-3 bg-gray-50 dark:bg-gray-800" data-controller="blob-metadata">
    <div class="flex items-center justify-center mb-2">
      <button data-action="click->blob-metadata#toggleEdit"
        data-blob-metadata-target="editButton"
        class="text-xs px-2 py-1 text-white">
        Edit Copyright Information
      </button>
    </div>
    <!-- View Mode -->
    <div data-blob-metadata-target="viewMode">
    </div>
    <!-- Edit Mode -->
    <div data-blob-metadata-target="editMode" class="hidden">
      <div class="space-y-3" style="padding: 10px;">
        <div class="flex items-center gap-2" style="padding: 10px;">
          <input type="checkbox"
                 data-blob-metadata-target="copyrightCheckbox"
                 <%= 'checked' if is_copyrighted %>
                 class="w-4 h-4 text-blue-600 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500">
          <label class="text-sm font-medium text-gray-700 dark:text-gray-200">This attachment is copyrighted</label>
        </div>
        <div style="padding: 10px;">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
            Purchase Link: <span class="text-red-600">*</span>
            <span class="text-xs text-gray-500">(required if copyrighted)</span>
          </label>
          <input type="text"
                 data-blob-metadata-target="purchaseUrlInput"
                 value="<%= purchase_url %>"
                 placeholder="https://www.amazon.com/..."
                 class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-200">
        </div>
        <div class="flex gap-2"  style="padding: 10px;">
          <button data-action="click->blob-metadata#save"
            data-blob-sgid="<%= blob.signed_id %>"
            class="px-3 py-1 text-sm bg-blue-600 hover:bg-blue-500 text-white rounded" style="padding:3px">
            Save
          </button>
          <button data-action="click->blob-metadata#cancel"
            class="px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded" " style="padding:3px">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>
</figure>
