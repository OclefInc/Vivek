<%= turbo_frame_tag "lesson_#{@lesson.id}_description" do %>
  <%= form_with(model: @lesson, url: lesson_path(@lesson, {format: :html})) do |form| %>
    <div data-controller="attachment-selector attachment-metadata">
      <strong class="dark:text-gray-200">Description:</strong>
      <%= form.rich_text_area :description,
                              class: "trix-content",
                              data: { attachment_selector_target: "editor", attachment_metadata_target: "editor" } %>
      <% existing_attachments = @lesson.existing_description_attachments %>
      <% if existing_attachments.any? %>
        <div class="mb-2">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">
            Insert existing attachment:
          </label>
          <select data-attachment-selector-target="select"
                  data-action="change->attachment-selector#insert"
            class="block shadow rounded-lg border border-gray-200 dark:border-gray-600 outline-none px-3 py-2 w-full dark:bg-gray-800 dark:text-gray-200">
            <option value="">-- Select an attachment --</option>
            <% existing_attachments.each do |attachment| %>
              <option value="<%= attachment[:sgid] %>"
                      data-filename="<%= attachment[:filename] %>"
                      data-content-type="<%= attachment[:blob].content_type %>"
                      data-byte-size="<%= attachment[:blob].byte_size %>"
                      data-url="<%= url_for(attachment[:blob]) %>"
                      data-copyrighted="<%= attachment[:description_copyrighted] %>"
                      data-purchase-url="<%= attachment[:description_purchase_url] %>">
                <%= attachment[:filename] %> (from <%= attachment[:lesson_name] %>)
              </option>
            <% end %>
          </select>
        </div>
      <% end %>
      <div class="mt-4 flex gap-2">
        <%= form.submit "Save", class: "px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium cursor-pointer" %>
        <%= link_to "Cancel", lesson_path(@lesson), class: "px-4 py-2 bg-gray-100 hover:bg-gray-50 rounded-lg font-medium" %>
      </div>
      <!-- Copyright Modal for new attachments -->
      <div data-attachment-metadata-target="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4">
          <h3 class="text-lg font-medium text-gray-900 dark:text-gray-200 mb-4">Attachment Copyright Information</h3>
          <div class="space-y-4">
            <div class="flex items-center gap-2">
              <input type="checkbox"
                     data-attachment-metadata-target="copyrightCheckbox"
                     class="w-4 h-4 text-blue-600 bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500">
              <label class="text-sm font-medium text-gray-700 dark:text-gray-200">This attachment is copyrighted</label>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-1">Amazon Purchase Link (optional):</label>
              <input type="text"
                     data-attachment-metadata-target="purchaseUrl"
                     placeholder="https://www.amazon.com/..."
                     class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-800 dark:text-gray-200">
            </div>
          </div>
          <div class="mt-6 flex gap-2 justify-end">
            <button data-action="click->attachment-metadata#cancel"
              class="px-4 py-2 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg font-medium dark:text-gray-200">
              Skip
            </button>
            <button data-action="click->attachment-metadata#save"
              class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>
  <% end %>
<% end %>
